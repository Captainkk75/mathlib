import data.fintype.basic
import group_theory.order_of_element
import tactic.zify
import data.nat.totient
import data.zmod.basic
import number_theory.padics.padic_norm
import field_theory.finite.basic
import data.fintype.basic

def two_power_part (n : ℕ) := 2 ^ (padic_val_nat 2 n)

def odd_part (n : ℕ) := n / two_power_part n

def binpow {M} [has_one M] [has_mul M] (m : M) : ℕ → M :=
nat.binary_rec 1 (λ b _ ih, let ih2 := ih * ih in cond b (m * ih2) ih2)

def fast_two_multiplicity : ℕ → ℕ :=
nat.binary_rec 0 (λ b _ ih, cond b 0 (ih+1))

def fast_odd_part (n : ℕ) := n / (2 ^ fast_two_multiplicity n)

def fast_strong_probable_prime (n : nat) (a : zmod n) : Prop :=
binpow a (fast_odd_part (n-1)) = 1
∨ (∃ r : ℕ, r < fast_two_multiplicity (n-1) ∧ binpow a (2^r * fast_odd_part(n-1)) = -1)

def fermat_strong_probable_prime (n : nat) (a : zmod n) : Prop :=
binpow a (n-1) = 1


instance {n : ℕ} {a : zmod n} : decidable (fast_strong_probable_prime n a) := or.decidable
--instance {n : ℕ} {a : zmod n} : decidable (fermat_strong_probable_prime n a) := by library_search

/- lemma strong_probable_prime_iff_fast_strong_probable_prime (n : nat) (a : zmod n) :
  strong_probable_prime n a ↔ fast_strong_probable_prime n a :=
begin
  unfold strong_probable_prime,
  unfold fast_strong_probable_prime,
  sorry,
end -/

/- #eval fast_two_multiplicity 10000

lemma fast_two_multiplicity_eq_padic_val_nat_two (n : ℕ) :
  padic_val_nat 2 n = fast_two_multiplicity n :=
begin
  sorry,
end -/

--TODO(Bolton): Find a way of making modular exponentiation faster
set_option profiler true
-------#eval to_bool (fast_strong_probable_prime 7320764159844077165009308901107483410368915454742416400175302951531353754769661186133664993273725722294839946239627799291540737402994105118773826496621684513647339896664323676244618229782599462758634004929519159268721205866783988405603965420142754460565135705623401107697493820384066033584945001327360108220659950830457005933691816021367579930822800030632473304431352927220792268527344983173031769898882197420979315482642629392296420332414299725499379820198580431721077602685960495637729487913624165756307586241501493452459407333163406518806076318226264320497224968184100691384561349696393983603114038479470167132384600385631126256100593512580854607138527077512332106874625566796801166419039845624315620777963185087024655200774884355466264428703344550594822563546988047715951394601042292641673678050014096879349008394480756938414445965259609634260277840055374060885679919753654375993457553570430913343869904478222544113850326745011088058779733755041610460552699632317523586702688779209063397341738741 1012)
--#eval to_bool (fast_strong_probable_prime 1000003 2)
--#eval binpow (1024 : zmod 8469627293895910728853889660978710817164812082142989733076166118124179362694365152458133706500165359) (fast_odd_part 8469627293895910728853889660978710817164812082142989733076166118124179362694365152458133706500165358)
--#eval to_bool (nat.prime 1000003)
--#eval to_bool (fast_strong_probable_prime 99999997 4)
--#eval (multiplicity 2 99999997)
--#eval to_bool (nat.prime 100123456789)
--#eval to_bool (fermat_strong_probable_prime 7320764159844077165009308901107483410368915454742416400175302951531353754769661186133664993273725722294839946239627799291540737402994105118773826496621684513647339896664323676244618229782599462758634004929519159268721205866783988405603965420142754460565135705623401107697493820384066033584945001327360108220659950830457005933691816021367579930822800030632473304431352927220792268527344983173031769898882197420979315482642629392296420332414299725499379820198580431721077602685960495637729487913624165756307586241501493452459407333163406518806076318226264320497224968184100691384561349696393983603114038479470167132384600385631126256100593512580854607138527077512332106874625566796801166419039845624315620777963185087024655200774884355466264428703344550594822563546988047715951394601042292641673678050014096879349008394480756938414445965259609634260277840055374060885679919753654375993457553570430913343869904478222544113850326745011088058779733755041610460552699632317523586702688779209063397341738741 23)

--example : nat.prime 6143411621 :=
--begin
  --norm_num,
--end
